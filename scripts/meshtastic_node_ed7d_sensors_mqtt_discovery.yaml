alias: Meshtastic Node MAC4 MQTT Discovery
sequence:
  - action: mqtt.publish
    data:
      topic: homeassistant/sensor/msh-<node_id>/lastseen/config
      retain: true
      payload: |-
        {
          "name": "Last Seen",
          "unique_id": "last_seen_MAC4",
          "state_topic": "meshtastic/<node_id>/all",
          "icon": "mdi:clock-time-eight-outline",
          "entity_category": "diagnostic",
          "value_template": {% raw %}"{{ (value_json.timestamp)|timestamp_custom('%-d %b %-H:%M', true) }}"{% endraw %},
          "device": 
          {
              "identifiers": ["MAC4"],
              "name": "Meshtastic Node MAC4",
              "model": "T114",
              "manufacturer": "Heltec",
              "sw_version": "2.5.9.936260f",
              "hw": "2.0",
              "sn": "<node_id> * WJPM"
          }
        }
      qos: "0"
  - action: mqtt.publish
    data:
      topic: homeassistant/sensor/msh-<node_id>/snr/config
      retain: true
      payload: |-
        {
          "name": "SNR",
          "unique_id": "snr_MAC4",
          "state_topic": "meshtastic/<node_id>/all",
          "state_class": "measurement",
          "icon": "mdi:broadcast",
          "entity_category": "diagnostic",
          "value_template": {% raw %}"{{ value_json.snr }}"{% endraw %},
          "device": 
          {
              "identifiers": ["MAC4"]
          }
        }
      qos: "0"
  - action: mqtt.publish
    data:
      topic: homeassistant/sensor/msh-<node_id>/rssi/config
      retain: true
      payload: |-
        {
          "name": "RSSI",
          "unique_id": "rssi_MAC4",
          "state_topic": "meshtastic/<node_id>/all",
          "state_class": "measurement",
          "icon": "mdi:broadcast",
          "entity_category": "diagnostic",
          "value_template": {% raw %}"{{ value_json.rssi }}"{% endraw %},
          "device": 
          {
              "identifiers": ["MAC4"]
          }
        }
      qos: "0"
  - action: mqtt.publish
    data:
      topic: homeassistant/sensor/msh-<node_id>/uptime/config
      retain: true
      payload: |-
        {
          "name": "Days Up",
          "unique_id": "uptime_MAC4",
          "state_topic": "meshtastic/<node_id>/telemetry",
          "icon": "mdi:clock-time-eight-outline",
          "entity_category": "diagnostic",
          "value_template": {% raw %}"{{ ( value_json.payload.uptime_seconds / (24*60*60)) |  float | round(3) }}"{% endraw %},
          "device": 
          {
              "identifiers": ["MAC4"]
          }
        }
      qos: "0"
  - action: mqtt.publish
    data:
      topic: homeassistant/sensor/msh-<node_id>/batteryvoltage/config
      retain: true
      payload: |-
        {
          "name": "Battery Voltage",
          "unique_id": "battery_voltage_MAC4",
          "state_topic": "meshtastic/<node_id>/telemetry",
          "value_template": {% raw %}"{{ (value_json.payload.voltage | float) | round(2) }}"{% endraw %},
          "unit_of_measurement": "V",
          "icon": "mdi:current-dc",
          "entity_category": "diagnostic",
          "device": 
          {
              "identifiers": ["MAC4"]

          }
        }
      qos: "0"
    enabled: true
  - action: mqtt.publish
    data:
      topic: homeassistant/sensor/msh-<node_id>/batterylevel/config
      retain: true
      payload: |-
        {
          "name": "Battery Level",
          "unique_id": "battery_level_MAC4",
          "state_topic": "meshtastic/<node_id>/telemetry",
          "device_class": "battery",
          "unit_of_measurement": "%",
          "entity_category": "diagnostic",
          "value_template": {% raw %}"{{ value_json.payload.battery_level }}"{% endraw %},
          "device": 
          {
              "identifiers": ["MAC4"]
          }
        }
      qos: "0"
    enabled: true
  - action: mqtt.publish
    data:
      topic: homeassistant/sensor/msh-<node_id>/chanutil/config
      retain: true
      payload: |-
        {
          "name": "Channel Utilization",
          "unique_id": "channel_utilization_MAC4",
          "state_topic": "meshtastic/<node_id>/telemetry",
          "state_class": "measurement",
          "unit_of_measurement": "%",
          "icon": "mdi:broadcast",
          "value_template": {% raw %}"{{ (value_json.payload.channel_utilization | float) | round(2) }}"{% endraw %},
          "device": 
          {
              "identifiers": ["MAC4"]
          }
        }
      qos: "0"
  - action: mqtt.publish
    data:
      topic: homeassistant/sensor/msh-<node_id>/airutil/config
      retain: true
      payload: |-
        {
          "name": "Air Utilization",
          "unique_id": "air_utilization_MAC4",
          "state_topic": "meshtastic/<node_id>/telemetry",
          "state_class": "measurement",
          "icon": "mdi:broadcast",
          "unit_of_measurement": "%",
          "value_template": {% raw %}"{{ (value_json.payload.air_util_tx | float) | round(2) }}"{% endraw %},
          "device": 
          {
              "identifiers": ["MAC4"]
          }
        }
      qos: "0"
  - action: mqtt.publish
    data:
      topic: homeassistant/sensor/msh-<node_id>/user/config
      retain: true
      payload: |-
        {
          "name": "User",
          "unique_id": "user_MAC4",
          "state_topic": "meshtastic/<node_id>/nodeinfo",
          "icon": "mdi:information-box-outline",
          "entity_category": "diagnostic",
          "value_template": {% raw %}"{{ value_json.payload.id }}"{% endraw %},
          "device": 
          {
              "identifiers": ["MAC4"]
          }
        }
      qos: "0"
  - action: mqtt.publish
    data:
      topic: homeassistant/sensor/msh-<node_id>/callsign/config
      retain: true
      payload: |-
        {
          "name": "Call Sign",
          "unique_id": "callsign_MAC4",
          "state_topic": "meshtastic/<node_id>/nodeinfo",
          "icon": "mdi:information-box-outline",
          "entity_category": "diagnostic",
          "value_template": {% raw %}"{{ value_json.payload.shortname }}"{% endraw %},
          "device": 
          {
              "identifiers": ["MAC4"]
          }
        }
      qos: "0"
    enabled: true
  - action: mqtt.publish
    data:
      topic: homeassistant/sensor/msh-<node_id>/node/config
      retain: true
      payload: |-
        {
          "name": "Node",
          "unique_id": "node_MAC4",
          "state_topic": "meshtastic/<node_id>/all",
          "icon": "mdi:information-box-outline",
          "entity_category": "diagnostic",
          "value_template": {% raw %}"{{ value_json.from }}"{% endraw %},
          "enable": "0",
          "device": 
          {
              "identifiers": ["MAC4"]
          }
        }
      qos: "0"
    enabled: false
description: ""
mode: single
